name: CI

on:
   push:
      branches: [main, develop]
   pull_request:
      branches: [main]

jobs:
   test:
      runs-on: ubuntu-latest
      strategy:
         matrix:
            node-version: [16, 18, 20, 22]
      steps:
         - uses: actions/checkout@v4

         - name: Setup Node.js ${{ matrix.node-version }}
           uses: actions/setup-node@v4
           with:
              node-version: ${{ matrix.node-version }}

         - name: Install dependencies
           run: npm ci

         - name: Run tests
           run: npm test

         - name: Run linting
           run: npm run lint

         - name: Build package
           run: npm run build

   release:
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      needs: test
      runs-on: ubuntu-latest
      permissions:
         contents: write
      steps:
         - uses: actions/checkout@v4
           with:
              fetch-depth: 0

         - name: Get version from package.json
           id: version
           run: echo "version=v$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

         - name: Create Draft Release
           uses: softprops/action-gh-release@v1
           with:
              tag_name: ${{ steps.version.outputs.version }}
              name: Release ${{ steps.version.outputs.version }}
              draft: true
              generate_release_notes: true
